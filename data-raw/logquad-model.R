lqcoef <- structure(list(Sex = structure(c(1L, 1L, 1L, 1L, 1L, 1L, 1L,
                                           1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L,
                                           1L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L,
                                           2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L),
                                         .Label = c("Female", "Male", "Total"), class = "factor"),
                         AgeGroup = structure(c(1L, 2L, 14L,
                                                3L, 7L, 8L, 9L, 10L, 11L, 12L, 13L, 15L, 16L, 17L, 18L, 19L,
                                                20L, 21L, 22L, 23L, 24L, 4L, 5L, 6L, 1L, 2L, 14L, 3L, 7L, 8L,
                                                9L, 10L, 11L, 12L, 13L, 15L, 16L, 17L, 18L, 19L, 20L, 21L, 22L,
                                                23L, 24L, 4L, 5L, 6L),
                                              .Label = c("0", "1-4", "10-14", "100-104",
                                                         "105-109", "110+", "15-19", "20-24", "25-29", "30-34", "35-39",
                                                         "40-44", "45-49", "5-9", "50-54", "55-59", "60-64", "65-69",
                                                         "70-74", "75-79", "80-84", "85-89", "90-94", "95-99"), class = "factor"),
                         ax = c(-0.66186281334383, NA, -2.56080042827845, -3.2434878477907,
                                -3.1099288731249, -2.97888535560963, -3.01850744347823, -3.02007345064568,
                                -3.1487394748916, -3.2689991388194, -3.52021817909588, -3.40763858322437,
                                -3.25866971099761, -2.89072949528753, -2.66082588429976,
                                -2.29491646957014, -2.04141341199065, -1.73079992673339,
                                -1.44730928191656, -1.15821785044026, -0.865460308477975,
                                -0.629412748419085, -0.428180253428647, -0.296637588244167,
                                -0.510107073962714, NA, -3.04354042028688, -3.95543164882019,
                                -3.93740052043582, -3.4164986611631, -3.42366110538792, -3.44384462756528,
                                -3.41977578780034, -3.38285782742949, -3.44556504331732,
                                -3.42168407832628, -3.4144040006723, -3.14020739430562, -2.8565469687576,
                                -2.41138733840464, -2.04114778656127, -1.64560207675431,
                                -1.32027803108074, -1.03683382739214, -0.731049386156319,
                                -0.502444761065897, -0.327491127748372, -0.221175648673133),
                         bx = c(0.768375458075558, NA, 1.79373011625491, 1.66526158454675,
                                1.5797313207243, 1.5053346523347, 1.37293093611924, 1.28785756036351,
                                1.1070968843203, 0.933945495750759, 0.66423763821388, 0.55555206086523,
                                0.446083766592483, 0.398831600180196, 0.259052615142433,
                                0.175935416831952, 0.0480799155591892, -0.00639781767232538,
                                -0.0530736182674413, -0.0616508044525306, -0.0598255797151004,
                                -0.0512937141148681, -0.0341091971534106, -0.0229038259495638,
                                0.816432067570651, NA, 1.52698179637429, 1.23895852618124,
                                1.04247971314827, 1.16506229518495, 1.14438512774588, 1.06824286396208,
                                0.962047590094026, 0.833684934341847, 0.603887660258663,
                                0.400074172047341, 0.176036145554819, 0.0920879367556321,
                                0.0217311014927721, 0.038758091016001, 0.00926081295777703,
                                0.008493270232893, -0.0183437558715347, -0.0314240694580901,
                                -0.0169880858480371, -0.00809281483923157, 6.03004389815864e-05,
                                0.00280790366227191),
                         cx = c(-0.0276526585094366, NA, 0.108216798562532,
                                0.108766992722135, 0.114700047874228, 0.101140941230641,
                                0.0815358641018554, 0.0778066615434165, 0.0637190778615326,
                                0.0532645824343458, 0.028940536431634, 0.0208263976424387,
                                0.0101357810784305, 0.00416416475640234, -0.0134545437606229,
                                -0.0228570091951607, -0.0353733886507841, -0.0347172980592731,
                                -0.0327308729914504, -0.025930204151502, -0.0198085213587724,
                                -0.013442435994291, -0.00748259441202121, -0.00406758137892444,
                                -0.0245146667827915, NA, 0.081660318917543, 0.0638495465637181,
                                0.0749508953560368, 0.0945484255006006, 0.0904725205022772,
                                0.0814323811155612, 0.0714160686973468, 0.0608632135453063,
                                0.036249800687667, 0.0138365101311965, -0.0128101074119134,
                                -0.0216442591190353, -0.0282702581602213, -0.023489596309721,
                                -0.0252409364112197, -0.0221101299327932, -0.0218625016743341,
                                -0.0183977248259947, -0.0132725927876603, -0.0086277579926198,
                                -0.00476005675454231, -0.0026504159205318),
                         vx = c(0, NA, 0.278808239532778, 0.342303850077532, 0.400651352065886,
                                0.413295601703652, 0.388381361268693, 0.339109883184782,
                                0.282881596445607, 0.224621867430123, 0.177428479313842,
                                0.142885823566349, 0.118995407806435, 0.0806551650937455,
                                0.0571175061539533, 0.0294545653670851, 0.0114467891147405,
                                0.00325923672487253, 0.00397136749889219, 0, 0, 0, 0, 0,
                                0, NA, 0.171998295840614, 0.16826320631001, 0.216109468588607,
                                0.302174752514936, 0.362364394513608, 0.384826779170831,
                                0.377948103547558, 0.352974487081659, 0.306021622001942,
                                0.256350699123925, 0.201668788651162, 0.16160884408274, 0.121574259404048,
                                0.0864481864193535, 0.0536683076419322, 0.0315725222264515,
                                0.00611987620003284, 0, 0, 0, 0, 0),
                         agemid = c(0, 2.5, 7,
                                    12, 17, 22, 27, 32, 37, 42, 47, 52, 57,
                                    62, 67, 72, 77, 82, 87, 92, 97, 102, 107,
                                    NA, 0, 2.5, 7, 12, 17, 22, 27, 32, 37, 42,
                                    47, 52, 57, 62, 67, 72, 77, 82, 87, 92,
                                    97, 102, 107, NA)),
                    .Names = c("Sex", "AgeGroup", "ax", "bx", "cx", "vx", "agemid"), row.names = c(NA, 48L), class = "data.frame")

lqcoef <- reshape(lqcoef, timevar="Sex", idvar=c("AgeGroup", "agemid"), direction="wide")

names(lqcoef) <- gsub(".Female", "_f", names(lqcoef))
names(lqcoef) <- gsub(".Male", "_m", names(lqcoef))
lqcoef <- subset(lqcoef, agemid >= 5)

lqcoef1 <- data.frame(age = 15:80,
                      ax_m = with(lqcoef, spline(agemid, ax_m, xout=15:80))$y,
                      bx_m = with(lqcoef, spline(agemid, bx_m, xout=15:80))$y,
                      cx_m = with(lqcoef, spline(agemid, cx_m, xout=15:80))$y,
                      vx_m = with(lqcoef, spline(agemid, vx_m, xout=15:80))$y,
                      ax_f = with(lqcoef, spline(agemid, ax_f, xout=15:80))$y,
                      bx_f = with(lqcoef, spline(agemid, bx_f, xout=15:80))$y,
                      cx_f = with(lqcoef, spline(agemid, cx_f, xout=15:80))$y,
                      vx_f = with(lqcoef, spline(agemid, vx_f, xout=15:80))$y)

## matplot(lqcoef1$age, lqcoef1[,-1], type="l", lty=1)
## matpoints(lqcoef$age, lqcoef[,-(1:2)], pch=1)


1-exp(-sum(exp(with(lqcoef1, ax_m + bx_m*log(0.05) + cx_m*log(0.05)^2 + vx_m-2))[1:45]))
1-exp(-5*sum(exp(with(lqcoef, ax_m + bx_m*log(0.05) + cx_m*log(0.05)^2 + vx_m-2))[3:11]))

h <- log(0.08)
k <- 0

lq1_m <- as.matrix(subset(lqcoef1, age %in% 15:59, c("ax_m", "bx_m", "cx_m", "vx_m")))
lq1_f <- as.matrix(subset(lqcoef1, age %in% 15:59, c("ax_f", "bx_f", "cx_f", "vx_f")))

1-exp(sum(-5*exp(as.matrix(lqcoef[3:11, c("ax_f", "bx_f", "cx_f", "vx_f")]) %*% c(1, h, h^2, k))))


## lq_45q15 <- function(h, k=0){

1-exp(-sum(exp(lq1_f %*% c(1, h, h^2, k))))
1-exp(-sum(exp(lq1_m %*% c(1, h, h^2, k))))



lq1_m <- as.matrix(lqcoef1[,c("ax_m", "bx_m", "cx_m", "vx_m")])
lq1_f <- as.matrix(lqcoef1[,c("ax_f", "bx_f", "cx_f", "vx_f")])

  

library(mgcv)



xx <- seq(1975, 2020, 0.1)
sm15 <- smoothCon(s(xx, bs="bs", k=15), data.frame(xx=xx), absorb.cons=TRUE, diagonal.penalty=TRUE)[[1]]
sim15 <- sm15$X %*% rbind(matrix(rnorm(10000*13, 0, 0.1), 13), 0)


sm50 <- smoothCon(s(xx, bs="bs", k=50), data.frame(xx=xx), absorb.cons=TRUE, diagonal.penalty=TRUE)[[1]]
sim50 <- sm50$X %*% rbind(matrix(rnorm(10000*48, 0, 0.1), 48), 0)

matplot(xx, sim, type="l")

matplot(xx, t(apply(sim, 1, quantile, c(.025, 0.975))), type="l", lty=1, col=1)

matplot(xx, t(apply(sim15, 1, quantile, c(.025, 0.975))), type="l", lty=1, col=2)

matplot(xx, t(apply(sim50, 1, quantile, c(.025, 0.975))), type="l", lty=1, col=2)
