---
title: "Basic example of sexual debut simulation"
author: "Kinh Nguyen"
date: "`r Sys.Date()`"
output: 
  html_vignette: 
    toc: true
    fig_width: 7
    fig_height: 5
bibliography: ref.bib
vignette: >
  %\VignetteIndexEntry{Basic example of sexual debut simulation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  comment = "#>"
)
```

This vignette develops the work flow for simulating the EPP-ASM model with
sexual debut and sexual mixing model.

Changes in population movements

- Base population in the sexual debut age range is initiated as inactive and
  then move to active based on the debut rate.
- Entrant population enters the model as sexual inactive and then moves to
  sexual active with the debut rate.
- There are separate HIV and ART pop for sexual inactive group, these also move
  from inactive to active.

Changes in indexing

- HIV and ART pop is spitted to single year in the debut age range instead of
  by age-group currently, the older age-groups (max debut age + 1) are grouped
  as the original age-group but with new group index (`update_fp_debut`).

Changes in calculations

- New births were adjusted to match ASFR
- Force of infections were adjusted to match IRR by age and sex

Changes in fp

- New fields to specify MODEL, VERSION, sexual debut rate, sexual mixing
  matrices 

Changes in code

- new C++ version, "K" is implemented as C++ classes
- R version is implemented with R6 class to test and debug new C++ version
- new version `MODEL==0` to run demographic projection only without infection
  processes

```{r echo=FALSE, message=FALSE, load}
## checkout `debut-withClass` branch
library(magrittr)
devtools::load_all()
```

## Preparing EPP-ASM inputs

```{r, eppasm_inputs}
# Use Botswana for convinient
pjnz <- system.file("extdata/testpjnz", "Botswana2018.PJNZ", package="eppasm")
bw <- prepare_spec_fit(pjnz, proj.end=2021.5)
```

### EPP model with single set of parameter inputs

Prepare model parameters from parameter vector input
```{r, single_param}
theta_ur <- c(-0.63758, -2.76655, -1.26204, 1996.65945, 0.00778, 0.05195,
              0.05103, 0.032, 0.01765, 0.01154, -0.00028, 0.01627, -0.00051,
              0.01439, -0.00937, -0.01135, 0.03692, 0.14959, 0.00803, 0.02424,
              -0.03548, 3.65223, -0.02515, -4.74563, 0.26259, -6.90124, 0.01583)

fp <- attr(bw$Urban, "specfp")
# Constructing `fp$rt`
fp <- prepare_rhybrid(fp, rw_start = 2005, rw_dk = 1)

## Set some flags that are set in fitmod(), (later improve this code...)
fp$ancsitedata <- TRUE
fp$ancrt <- "both"
fp$logitiota <- TRUE
fp$rw_start <- 2005
fp$incidmod <- "eppspectrum"

# create rvec, iota, update frr,...
param <- fnCreateParam(theta_ur, fp)
fp_par <- update(fp, list = param)
```

Simulate the model

### C++ version of the current model
```{r, simulate_model}
fp_par$VERSION='C'; mod <- simmod(fp_par)
```

### R version of the current model
```{r}
fp_par$VERSION='R'; modR <- simmod(fp_par)

expect_equal(prev(mod), prev(modR))
expect_equal(incid(mod), incid(modR))
```

### New C++ version of the current model
```{r}
fp_par$VERSION='K'; modK <- simmod(fp_par)

expect_equal(prev(mod), prev(modK))
expect_equal(incid(mod), incid(modK))
```

## Demographic model (R only)

```{r, demographic, fig.height=6, fig.cap = "Figure: Demographic only"}
fp_par$VERSION='R'
fp_par$ss$MODEL=0
demR <- simmod(fp_par)
plot(demR)
```

## Sexual debut (R and new C)

The function `update_fp_debut` will update `fp` with default sexual debut rate
capped off at age 30. To run with default parameter set `MODEL==2`;

```{r}
fp_par$ss$MODEL=2
fp_par$VERSION="R"; dbR <- simmod(fp_par)
fp_par$VERSION="K"; dbK <- simmod(fp_par)
expect_equal(prev(dbR), prev(dbK))
```

## Sexual mixing (R and new C)

Set `fp$ss$MIXING=TRUE` to run the model with default sexual mixing matrices
(in `extdata`)

```{r}
fp_par$ss$MODEL=1
fp_par$ss$MIX=TRUE
fp_par$VERSION="R"; mxR <- simmod(fp_par)
fp_par$VERSION="K"; mxK <- simmod(fp_par)
expect_equal(prev(mxR), prev(mxK))
```

```{r echo=FALSE, fig.cap = "Three versions prevalence"}
plot(prev(mod), type='l', xlab='year from 1970', ylab='prevalence 15-49')
lines(prev(dbK), col=2, lty=2)
lines(prev(mxK), col=3, lty=3)
legend('topleft', c('current', '+DB', '+MX'), lwd=2, lty=1:3, cex=.7)
```