
## Prior mean for TIPS coefficients
tips_mu <- c(-0.0748248461309845, -0.0608818557328581, 0.0556677950045084, 0.00521406072834967,
             -0.117325342676824, 0.00806923685176465, -0.181206440739286, -0.285385881708066,
             -0.266832375293271, -0.488944015713564, 0.225367858910394, -0.46951901992304,
             -0.292620918776733, -0.454441758918277, -0.440091792796173)

## Prior variance for TIPS coefficients
## Covariance matrix is degenerate because of linear dependency. Becomes proper when adding bias variance.
tips_V <- structure(c(0.20208063833634, 0.00852449284922515, -0.00273128600273031,
                      -0.00579320684649484, -0.00648240338566431, -0.00549050380559142,
                      -0.00668507745507025, 0.00713193336813014, 0.0179112951380893,
                      0.0208672856385429, 0.0286377150671948, 0.0197777279837454, 0.0246621814031547,
                      0.019458773147288, 0.0161025506870036, 0.00852449284922512, 0.00442529788753997,
                      -0.00181261763740189, -0.00261268025013807, -0.00197242883542144,
                      -0.00405336758133255, -0.003530168265632, -0.00164295592903328,
                      -0.00159290540559741, 0.00207124159994744, -0.00275276259291363,
                      0.00224675852294295, -0.00131714398616185, -0.00113876577306774,
                      -0.00210417849275931, -0.00273128600273027, -0.00181261763740189,
                      0.00289477805518417, -0.00108216041778228, -0.00145934881491884,
                      -0.0012573894994471, 0.00274844020137598, -0.0026533252340587,
                      -0.00123385664673044, -0.00286384096661969, 0.00197042289638132,
                      0.00268643325268254, 0.000261154842521498, -0.00091046967421606,
                      -0.000627334382391845, -0.00579320684649485, -0.00261268025013807,
                      -0.00108216041778228, 0.00369484066792035, 0.00343177765034028,
                      0.00531075708077965, 0.000781728064256013, 0.00429628116309199,
                      0.00282676205232785, 0.000792599366672259, 0.000782339696532311,
                      -0.00493319177562549, 0.00105598914364035, 0.0020492354472838,
                      0.00273151287515116, -0.00648240338566429, -0.00197242883542144,
                      -0.00145934881491884, 0.00343177765034028, 0.0139683242311663,
                      0.00866795084198128, -0.00270536763838765, 0.00960280795871316,
                      0.010709777420421, 0.0109357373240887, 0.00026534921022282, -0.0139836099757931,
                      0.00531713258475038, 0.00518221668215563, 0.0134782178432037,
                      -0.00549050380559143, -0.00405336758133255, -0.0012573894994471,
                      0.00531075708077965, 0.00866795084198127, 0.0162707610536563,
                      -0.00519779767451663, 0.0090437113166515, 0.0104762600791661,
                      0.00609102452710751, 0.0111708457750168, -0.024764910982246,
                      0.00393045040116628, 0.00239451273517783, 0.0037500471706474,
                      -0.00668507745507025, -0.003530168265632, 0.00274844020137599,
                      0.000781728064256013, -0.00270536763838764, -0.00519779767451662,
                      0.0366904633496645, 0.00939835258907615, 0.00490577512380166,
                      -0.00523870553655859, 0.0068236489077543, 0.0474145951615617,
                      0.00662443519546919, 0.00447893245796919, 0.000892502611659782,
                      0.00713193336813011, -0.00164295592903328, -0.0026533252340587,
                      0.00429628116309198, 0.00960280795871314, 0.00904371131665151,
                      0.00939835258907614, 0.0269906647097341, 0.017700554948602, 0.012375477937982,
                      0.0066472511962624, 0.00772926804723934, 0.0124331848180619,
                      0.0159683839251606, 0.0137284651660049, 0.0179112951380893, -0.00159290540559741,
                      -0.00123385664673044, 0.00282676205232785, 0.010709777420421,
                      0.0104762600791661, 0.00490577512380166, 0.017700554948602, 0.0274102936964867,
                      0.0126537718360955, 0.0158822009032788, -0.0100573489750697,
                      0.0113762284009053, 0.0091533417409424, 0.0128558832552106, 0.0208672856385429,
                      0.00207124159994744, -0.0028638409666197, 0.000792599366672256,
                      0.0109357373240887, 0.00609102452710751, -0.00523870553655858,
                      0.012375477937982, 0.0126537718360955, 0.0272586468404571, 0.0032617176335315,
                      -0.000215900012620157, 0.0144824413494033, 0.0184036795026625,
                      0.0222324447379636, 0.0286377150671948, -0.00275276259291363,
                      0.00197042289638131, 0.000782339696532316, 0.000265349210222819,
                      0.0111708457750168, 0.00682364890775429, 0.0066472511962624,
                      0.0158822009032788, 0.00326171763353148, 0.0345289812109246,
                      -0.00953000361806151, 0.00829909789016811, -0.00435331553848235,
                      -0.007232336158188, 0.0197777279837454, 0.00224675852294295,
                      0.00268643325268254, -0.0049331917756255, -0.0139836099757931,
                      -0.0247649109822459, 0.0474145951615617, 0.00772926804723935,
                      -0.0100573489750697, -0.000215900012620174, -0.00953000361806149,
                      0.120819330494803, 0.0181771502486897, 0.0262861025033673, 0.012997712169512,
                      0.0246621814031547, -0.00131714398616185, 0.000261154842521494,
                      0.00105598914364035, 0.00531713258475037, 0.0039304504011663,
                      0.00662443519546919, 0.0124331848180619, 0.0113762284009053,
                      0.0144824413494033, 0.00829909789016813, 0.0181771502486897,
                      0.0195597941275459, 0.0205758369517808, 0.0206457873831113, 0.019458773147288,
                      -0.00113876577306773, -0.000910469674216061, 0.0020492354472838,
                      0.00518221668215562, 0.00239451273517784, 0.00447893245796922,
                      0.0159683839251606, 0.00915334174094241, 0.0184036795026625,
                      -0.00435331553848232, 0.0262861025033673, 0.0205758369517808,
                      0.0348706508812915, 0.0302561704620504, 0.0161025506870037, -0.00210417849275931,
                      -0.000627334382391845, 0.00273151287515115, 0.0134782178432037,
                      0.00375004717064742, 0.00089250261165983, 0.013728465166005,
                      0.0128558832552107, 0.0222324447379636, -0.00723233615818795,
                      0.0129977121695121, 0.0206457873831114, 0.0302561704620504, 0.0431805529364648),
                    .Dim = c(15L, 15L))

sibmx_theta.shape <- 3.2
sibmx_theta.scale <- 2/3


create_sibmx_param <- function(theta_sibmx, fp){
  list(sibmx.theta = exp(theta_sibmx[1]),
       tipscoef = exp(theta_sibmx[2:16] %*% fp$natmx$tips_L + tips_mu))
}

lprior_sibmx <- function(theta_sibmx, fp){
  dgamma(exp(theta_sibmx[1]), sibmx_theta.shape, scale=sibmx_theta.scale, log=TRUE) + theta_sibmx[1] +
    sum(dnorm(theta_sibmx[2:16], log=TRUE))
}


#' Prepare sibling history mortality likelihood data
#'
prepare_sibmx_likdat <- function(sibmxdat, fp){
  anchor.year <- floor(min(fp$proj.steps))
  nyears <- fp$ss$PROJ_YEARS
  NG <- fp$ss$NG
  AG <- fp$ss$pAG

  sibmxdat$sidx <- as.integer(sibmxdat$sex)
  sibmxdat$aidx <- sibmxdat$agegr - (fp$ss$AGE_START-1)
  sibmxdat$yidx <- sibmxdat$period - (anchor.year - 1)
  sibmxdat$tipsidx <- sibmxdat$tips+1L

  sibmxdat <- subset(sibmxdat, aidx > 0)

  sibmxdat$arridx <- sibmxdat$aidx + (sibmxdat$sidx-1)*AG + (sibmxdat$yidx-1)*NG*AG

  return(sibmxdat)
}

#' Log negative binomial density
#'
#' Log negative binomial density, mu parameterization
#'
#' Log-density of negative binomial distribution. Parameter names and
#' parameterization matches the 'mu' parameterization of \code{\link{dnbinom}}.
#'
#' @param x vector of number of events.
#' @param size dispersion parameter.
#' @param mu mean expected number of events.
ldnbinom <- function(x, size, mu){
  prob <- size/(size+mu)
  lgamma(x+size) - lgamma(size) - lgamma(x+1) + size*log(prob) + x*log(1-prob)
}



#' Log-likelihood for sibling history mortality data
#'
#' Calculate the log-likelihood for sibling history mortality data
#'
#' !!! NOTE: does not account for complex survey design
#'
#' @param mx Array of age/sex-specific mortality rates for each year, output
#'   from function \code{\link{agemx}}.
#' @param tipscoef Vector of TIPS (time preceding survey) coefficients for
#'   relative risk of underreporting deceased siblings.
#' @param theta Overdispersion of negative binomial distribution.
#' @param sibmx.dat Data frame consisting of sibling history mortality data.
ll_sibmx <- function(mx, tipscoef, theta, sibmx.dat){

  ## predicted deaths: product of predicted mortality, tips coefficient, and person-years
  mu.pred <- mx[sibmx.dat$arridx] * tipscoef[sibmx.dat$tipsidx] * sibmx.dat$pys
  if(any(mu.pred < 0)) return(-Inf)

  return(sum(ldnbinom(sibmx.dat$deaths, theta, mu.pred)))
}
